# –°–µ—Ä–≤–∏—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∫–ª–∞–¥–æ–≤

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –Ω–∞ FastAPI –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π –æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ —Å–∫–ª–∞–¥–æ–≤, –ø–æ—Å—Ç—É–ø–∞—é—â–∏—Ö —á–µ—Ä–µ–∑ Apache Kafka. –°–µ—Ä–≤–∏—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç REST API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

## –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:** –ü–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö (FastAPI, SQLAlchemy, AIOKafka) –¥–ª—è –≤—ã—Å–æ–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –∏–∑ Kafka:** –°–ª—É—à–∞–µ—Ç —Ç–æ–ø–∏–∫ Kafka –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –æ –ø—Ä–∏–±—ã—Ç–∏–∏ (`arrival`) –∏ —É–±—ã—Ç–∏–∏ (`departure`) —Ç–æ–≤–∞—Ä–æ–≤.
- **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤:** –í–µ–¥–µ—Ç —É—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ –∫–∞–∂–¥–æ–º —Å–∫–ª–∞–¥–µ.
- **–ì–∞—Ä–∞–Ω—Ç–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–æ–∫ (`FOR UPDATE`) –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (`CHECK`), —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏.
- **REST API:** –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—Å—Ç–∞—Ç–∫–∞—Ö –∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π.
- **API –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏:** –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è —É–¥–æ–±–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π –ø—Ä—è–º–æ —á–µ—Ä–µ–∑ API.
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é OpenAPI (Swagger) –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–°–∏—Å—Ç–µ–º–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –ø–æ —Å–æ–±—ã—Ç–∏–π–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ.

```
  (API –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏)
         |
         v
+------------------+      +-----------------+      +--------------------+      +----------------+
| Kafka Producer   |----->|   Apache Kafka  |----->|   Kafka Consumer   |----->| Business Logic |
| (–≤–Ω—É—Ç—Ä–∏ —Å–µ—Ä–≤–∏—Å–∞) |      | (—Ç–æ–ø–∏–∫ —Å–æ–±—ã—Ç–∏–π) |      | (–≤–Ω—É—Ç—Ä–∏ —Å–µ—Ä–≤–∏—Å–∞)   |      | (Service Layer)|
+------------------+      +-----------------+      +--------------------+      +----------------+
                                                                                      |
                                                                                      v
                                                                            +----------------+
                                                                            |   PostgreSQL   |
                                                                            | (–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö)  |
                                                                            +----------------+
         ^
         |
+------------------+
|   REST API       |
| (FastAPI)        |
+------------------+

```

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **–ë—ç–∫–µ–Ω–¥:** Python 3.11, FastAPI
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** PostgreSQL
- **–ë—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π:** Apache Kafka
- **ORM:** SQLAlchemy (—Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –¥—Ä–∞–π–≤–µ—Ä–æ–º `asyncpg`)
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:** Redis (–∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–µ)
- **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è:** Docker, Docker Compose
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** Pytest, HTTPX

---

## –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Docker
- Docker Compose

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞

1.  **–°–∫–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:**
    ```bash
    git clone https://github.com/Whoagir/brist_warehouse.git
    cd <–Ω–∞–∑–≤–∞–Ω–∏–µ-–ø–∞–ø–∫–∏>
    ```

2.  **–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
    –°–∫–æ–ø–∏—Ä—É–π—Ç–µ `app.env.example` –≤ `app.env`. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è.
    ```bash
    cp app.env.example app.env
    ```

3.  **–°–æ–±–µ—Ä–∏—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:**
    –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Å–æ–±–µ—Ä–µ—Ç –æ–±—Ä–∞–∑, —Å–æ–∑–¥–∞—Å—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–æ–º–∞ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç —Å–µ—Ä–≤–∏—Å—ã –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ.
    ```bash
    docker-compose up --build -d
    ```

4.  **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
    - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É: **[http://localhost:8000/docs](http://localhost:8000/docs)**
    - –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞: **[http://localhost:8000/health](http://localhost:8000/health)**

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API

–í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ Swagger UI (`/docs`) –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

### –û—Å–Ω–æ–≤–Ω–æ–π API

#### 1. –ü–æ–ª—É—á–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ
–í–æ–∑–≤ÔøΩÔøΩ–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –∑–∞–ø–∞—Å–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —Å–∫–ª–∞–¥–µ.

- **`GET /api/warehouses/{warehouse_id}/products/{product_id}`**

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```bash
curl http://localhost:8000/api/warehouses/c1d70455-7e14-11e9-812a-70106f431230/products/4705204f-498f-4f96-b4ba-df17fb56bf55
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ (200 OK):**
```json
{
  "warehouse_id": "c1d70455-7e14-11e9-812a-70106f431230",
  "product_id": "4705204f-498f-4f96-b4ba-df17fb56bf55",
  "quantity": 100,
  "last_updated": "2025-07-25T18:00:00.000Z"
}
```

#### 2. –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏, –∞–≥—Ä–µ–≥–∏—Ä—É—è –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–∏–±—ã—Ç–∏–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–µ.

- **`GET /api/movements/{movement_id}`**

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ (–∫–æ–≥–¥–∞ –µ—Å—Ç—å –æ–±–∞ —Å–æ–±—ã—Ç–∏—è):**
```json
{
  "movement_id": "c6290746-790e-43fa-8270-014dc90e02e0",
  "source_warehouse": "WH-3322",
  "destination_warehouse": "c1d70455-7e14-11e9-812a-70106f431230",
  "product_id": "4705204f-498f-4f96-b4ba-df17fb56bf55",
  "quantity_sent": 100,
  "quantity_received": 95,
  "time_in_transit": "0:02:00",
  "quantity_difference": 5
}
```

### API –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π

–≠—Ç–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –ø–æ–∑–≤–æ–ª—è—é—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –≤ Kafka.

#### 1. –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–±—ã—Ç–∏–µ —Ç–æ–≤–∞—Ä–∞
- **`POST /api/simulate/arrival`**

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "product_id": "4705204f-498f-4f96-b4ba-df17fb56bf55",
  "warehouse_id": "c1d70455-7e14-11e9-812a-70106f431230",
  "quantity": 100,
  "movement_id": "c6290746-790e-43fa-8270-014dc90e02e0"
}
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ (202 Accepted):**
```json
{
  "message": "Arrival event sent to Kafka successfully.",
  "movement_id": "c6290746-790e-43fa-8270-014dc90e02e0",
  "message_id": "b3b53031-e83a-4654-87f5-b6b6fb09fd99"
}
```

#### 2. –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —É–±—ã—Ç–∏–µ —Ç–æ–≤–∞—Ä–∞
- **`POST /api/simulate/departure`**

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "product_id": "4705204f-498f-4f96-b4ba-df17fb56bf55",
  "warehouse_id": "25718666-6af6-4281-b5a6-3016e36fa557",
  "quantity": 100,
  "movement_id": "c6290746-790e-43fa-8270-014dc90e02e0"
}
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–í –ø—Ä–æ–µ–∫—Ç–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `pytest`.

1.  **–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã:**
    ```bash
    docker-compose up -d
    ```

2.  **–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã:**
    –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç —Ç–µ—Å—Ç—ã –≤–Ω—É—Ç—Ä–∏ —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ `app`.
    ```bash
    docker-compose exec app pytest -v -s
    ```

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å –æ—Ç—á–µ—Ç –æ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–∞—Ö.