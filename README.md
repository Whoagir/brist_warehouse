# Сервис мониторинга состояния складов

Микросервис на FastAPI для обработки событий о перемещении товаров со складов, поступающих через Apache Kafka. Сервис сохраняет историю перемещений, отслеживает актуальные остатки на складах и предоставляет REST API для получения этой информации.

## Ключевые возможности

- **Асинхронная обработка:** Построен на асинхронных технологиях (FastAPI, SQLAlchemy, AIOKafka) для высокой производительности.
- **Обработка событий из Kafka:** Слушает топик Kafka для получения событий о прибытии (`arrival`) и убытии (`departure`) товаров.
- **Отслеживание остатков:** Ведет учет количества каждого товара на каждом складе.
- **Гарантия целостности данных:** Использует блокировки на уровне строк (`FOR UPDATE`) и ограничения базы данных (`CHECK`), чтобы предотвратить отрицательные остатки.
- **REST API:** Предоставляет эндпоинты для получения информации об остатках и детализации перемещений.
- **API для симуляции:** Встроенные эндпоинты для удобной генерации тестовых событий прямо через API.
- **Автоматическая документация:** Генерирует интерактивную OpenAPI (Swagger) документацию.

## Архитектура

Система построена по событийно-ориентированной архитектуре.

```
  (API для симуляции)
         |
         v
+------------------+      +-----------------+      +--------------------+      +----------------+
| Kafka Producer   |----->|   Apache Kafka  |----->|   Kafka Consumer   |----->| Business Logic |
| (внутри сервиса) |      | (топик событий) |      | (внутри сервиса)   |      | (Service Layer)|
+------------------+      +-----------------+      +--------------------+      +----------------+
                                                                                      |
                                                                                      v
                                                                            +----------------+
                                                                            |   PostgreSQL   |
                                                                            | (База данных)  |
                                                                            +----------------+
         ^
         |
+------------------+
|   REST API       |
| (FastAPI)        |
+------------------+

```

## Технологический стек

- **Бэкенд:** Python 3.11, FastAPI
- **База данных:** PostgreSQL
- **Брокер сообщений:** Apache Kafka
- **ORM:** SQLAlchemy (с асинхронным драйвером `asyncpg`)
- **Кэширование:** Redis (интегрирован, но не используется в основной логике)
- **Контейнеризация:** Docker, Docker Compose
- **Тестирование:** Pytest, HTTPX

---

## Запуск проекта

### Требования
- Docker
- Docker Compose

### Установка

1.  **Склонируйте репозиторий:**
    ```bash
    git clone https://github.com/Whoagir/brist_warehouse.git
    cd <название-папки>
    ```

2.  **Создайте файл с переменными окружения:**
    Скопируйте `app.env.example` в `app.env`. При необходимости измените значения.
    ```bash
    cp app.env.example app.env
    ```

3.  **Соберите и запустите контейнеры:**
    Эта команда соберет образ, создаст все необходимые тома и запустит сервисы в фоновом режиме.
    ```bash
    docker-compose up --build -d
    ```

4.  **Проверьте, что все работает:**
    - Интерактивная документация API будет доступна по адресу: **[http://localhost:8000/docs](http://localhost:8000/docs)**
    - Эндпоинт для проверки состояния сервиса: **[http://localhost:8000/health](http://localhost:8000/health)**

---

## Использование API

Все эндпоинты доступны через Swagger UI (`/docs`) для интерактивного тестирования.

### Основной API

#### 1. Получить остатки товара на складе
Возвращает информацию о текущем запасе конкретного товара на конкретном складе.

- **`GET /api/warehouses/{warehouse_id}/products/{product_id}`**

**Пример запроса:**
```bash
curl http://localhost:8000/api/warehouses/c1d70455-7e14-11e9-812a-70106f431230/products/4705204f-498f-4f96-b4ba-df17fb56bf55
```

**Пример ответа (200 OK):**
```json
{
  "warehouse_id": "c1d70455-7e14-11e9-812a-70106f431230",
  "product_id": "4705204f-498f-4f96-b4ba-df17fb56bf55",
  "quantity": 100,
  "last_updated": "2025-07-25T18:00:00.000Z"
}
```

#### 2. Получить детали перемещения
Возвращает полную информацию о перемещении, агрегируя данные о прибытии и отправке.

- **`GET /api/movements/{movement_id}`**

**Пример ответа (когда есть оба события):**
```json
{
  "movement_id": "c6290746-790e-43fa-8270-014dc90e02e0",
  "source_warehouse": "WH-3322",
  "destination_warehouse": "c1d70455-7e14-11e9-812a-70106f431230",
  "product_id": "4705204f-498f-4f96-b4ba-df17fb56bf55",
  "quantity_sent": 100,
  "quantity_received": 95,
  "time_in_transit": "0:02:00",
  "quantity_difference": 5
}
```

### API для симуляции событий

Эти эндпоинты позволяют отправлять тестовые события в Kafka.

#### 1. Симулировать прибытие товара
- **`POST /api/simulate/arrival`**

**Тело запроса:**
```json
{
  "product_id": "4705204f-498f-4f96-b4ba-df17fb56bf55",
  "warehouse_id": "c1d70455-7e14-11e9-812a-70106f431230",
  "quantity": 100,
  "movement_id": "c6290746-790e-43fa-8270-014dc90e02e0"
}
```

**Пример ответа (202 Accepted):**
```json
{
  "message": "Arrival event sent to Kafka successfully.",
  "movement_id": "c6290746-790e-43fa-8270-014dc90e02e0",
  "message_id": "b3b53031-e83a-4654-87f5-b6b6fb09fd99"
}
```

#### 2. Симулировать убытие товара
- **`POST /api/simulate/departure`**

**Тело запроса:**
```json
{
  "product_id": "4705204f-498f-4f96-b4ba-df17fb56bf55",
  "warehouse_id": "25718666-6af6-4281-b5a6-3016e36fa557",
  "quantity": 100,
  "movement_id": "c6290746-790e-43fa-8270-014dc90e02e0"
}
```

---

## Тестирование

В проекте настроены интеграционные тесты с использованием `pytest`.

1.  **Убедитесь, что все сервисы запущены:**
    ```bash
    docker-compose up -d
    ```

2.  **Запустите тесты:**
    Эта команда выполнит тесты внутри работающего контейнера `app`.
    ```bash
    docker-compose exec app pytest -v -s
    ```

Вы должны увидеть отчет о успешно пройденных тестах.
